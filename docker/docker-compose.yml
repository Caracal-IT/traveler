name: traveler

services:
  traveler:
    container_name: traveler
    build:
      context: ..
      dockerfile: docker/Dockerfile
    ports:
      - "8080:8080"
    # Mount docker-specific config and logs from the host
    volumes:
      - ../configs/config.docker.yaml:/root/configs/config.yaml:ro
      - ../logs:/root/logs
    depends_on:
      - keycloak
      - elasticsearch
    restart: unless-stopped

  solace:
    container_name: solace
    image: solace/solace-pubsub-standard:latest
    shm_size: 1g
    ulimits:
      core: -1
      memlock:
        soft: -1
        hard: -1
    volumes:
      - ./solace/certs:/var/lib/solace/jail/certs
      # Mount the single CLI script explicitly to ensure Solace picks it up and to avoid permission/visibility issues
      - ./solace/solace-setup.cli:/var/lib/solace/jail/cliscripts/solace-setup.cli:ro
    deploy:
      restart_policy:
        condition: on-failure
        max_attempts: 1
    working_dir: /usr/sw
    environment:
      - username_admin_globalaccesslevel=admin
      - username_admin_password=admin
      - username=admin
      - password=admin
    ports:
      # Management UI (HTTP) exposed on host 8082 to avoid conflict with traveler (container 8080)
      - "8082:8080"
      # Management UI / SEMP (HTTPS)
      - "1943:1943"
      # SMF (Solace Messaging) + TLS
      - "55556:55555"
      - "55443:55443"
      # MQTT + TLS
      - "1883:1883"
      - "8883:8883"
      # AMQP + TLS
      - "5672:5672"
      - "5671:5671"
      # SMF over WebSocket + TLS
      - "8008:8008"
      - "8443:8443"
      # REST Messaging + TLS
      - "9000:9000"
      - "9443:9443"
      # Shell/CLI (SSH)
      - "2222:2222"
    restart: unless-stopped

  keycloak:
    container_name: keycloak
    image: quay.io/keycloak/keycloak:26.0
    command: start-dev --import-realm
    ports:
      - "8081:8080" # expose Keycloak on localhost:8081
    env_file:
      # Checked-in defaults (non-sensitive). You can override any values in the next file.
      - ./keycloak/keycloak.defaults.env
      # User credentials file (checked in with placeholders). Set your values locally before running.
      - ./keycloak/keycloak.user.env
    environment:
      # Be explicit about the import location/file, so Keycloak surely picks it up on the first start
      KEYCLOAK_IMPORT: /opt/keycloak/data/import/traveler-dev-realm.json
      # Relax hostname/HTTPS requirements for local development to avoid 403 HTTPS-required errors
      KC_HOSTNAME_STRICT: "false"
      KC_HOSTNAME_STRICT_HTTPS: "false"
      # If you later front Keycloak with a reverse proxy/SSL terminator, keep this as 'edge'
      KC_PROXY: edge
      # Explicitly set hostname URL to HTTP for local development
      KC_HOSTNAME_URL: http://localhost:8081
    volumes:
      - ./keycloak/realm-export:/opt/keycloak/data/import:ro
    restart: unless-stopped

  elasticsearch:
    image: docker.elastic.co/elasticsearch/elasticsearch:${ELK_VERSION}
    container_name: elk-elasticsearch
    environment:
      - discovery.type=single-node
      - xpack.security.enabled=false
      - ES_JAVA_OPTS=-Xms1g -Xmx1g
    ports:
      - "9200:9200"
      - "9300:9300"
    ulimits:
      memlock:
        soft: -1
        hard: -1
    volumes:
      - esdata:/usr/share/elasticsearch/data
    healthcheck:
      test: [ "CMD-SHELL", "curl -fsSL http://localhost:9200 >/dev/null || exit 1" ]
      interval: 10s
      timeout: 5s
      retries: 30
    restart: unless-stopped

  kibana:
    image: docker.elastic.co/kibana/kibana:${ELK_VERSION}
    container_name: elk-kibana
    environment:
      - ELASTICSEARCH_HOSTS=http://elasticsearch:9200
      - SERVER_NAME=kibana
    ports:
      - "5601:5601"
    depends_on:
      - elasticsearch
    restart: unless-stopped

volumes:
  esdata:
    driver: local
